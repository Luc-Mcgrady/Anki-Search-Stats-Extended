<script lang="ts">
    import { onDestroy } from "svelte"
    import IntervalBar from "./IntervalBar.svelte"
    import type { IntervalPieInfo } from "./IntervalPie"
    import IntervalPie from "./IntervalPie.svelte"
    import NoGraph from "./NoGraph.svelte"
    import { graph_mode, include_suspended, zero_inclusive } from "./stores"
    import GraphTypeSelector from "./GraphTypeSelector.svelte"
    import { i18n } from "./i18n"
    export let include_suspended_option = true
    export let zero_inclusive_option = false
    export let intervals: Record<number, number> | null
    export let pieInfo: IntervalPieInfo = {}
    export let average = false
    export let cumulative = false

    export let steps = 7 // For bar, scroll
    export let last = 21 // for bar, bar_size
    export let max = 30

    let pieSteps = steps
    let pieLast = last

    let barScroll = zero_inclusive_option ? 0 : 1
    let barSize = 1

    $: {
        if ($graph_mode === "Pie") {
            pieLast = last
            pieSteps = steps
        } else {
            barScroll = steps
            barSize = last
        }
    }

    const unsubscribe = graph_mode.subscribe((mode) => {
        if (mode === "Bar") {
            steps = barScroll
            last = barSize
        } else {
            steps = pieSteps
            last = pieLast
        }
    })

    onDestroy(unsubscribe)
</script>

<GraphTypeSelector>
    <label>
        <input type="radio" bind:group={$graph_mode} value="Pie" />
        {i18n("pie")}
    </label>
    <label>
        <input type="radio" bind:group={$graph_mode} value="Bar" />
        {i18n("bar")}
    </label>
</GraphTypeSelector>
<div>
    {#if zero_inclusive_option && $graph_mode == "Pie"}
        <label class="checkbox">
            <input type="checkbox" bind:checked={$zero_inclusive} />
            {i18n("zero-inclusive")}
        </label>
    {/if}
    {#if include_suspended_option}
        <label class="checkbox">
            <input type="checkbox" bind:checked={$include_suspended} />
            {i18n("include-suspended")}
        </label>
    {/if}
</div>
{#if intervals}
    {#if $graph_mode == "Pie"}
        <IntervalPie {intervals} {pieInfo} bind:last bind:steps {average}></IntervalPie>
    {:else}
        <IntervalBar
            {intervals}
            {pieInfo}
            bins={max}
            bind:binSize={last}
            bind:offset={steps}
            {average}
            {cumulative}
        ></IntervalBar>
    {/if}
{:else}
    <NoGraph></NoGraph>
{/if}

<style>
    label.checkbox {
        user-select: none;
        display: block;
    }
</style>
